# IRP 버퍼 관리 (커널 데이터 버퍼)

애플리케이션이나 디바이스 드라이버가 NtReadFile, NtWriteFile 같은 시스템 서비스를 사용해 IRP를 간접적으로 생성할 때    
I/O 매니져가 호출자의 입력 버퍼나 출력 버퍼의 관리에 관여를 할지 결정합니다.  
여기서 총 3가지의 서로 다른 방법을 제공하여 버퍼 관리를 합니다.  
 

## 버퍼드 I/O (Buffered I/O) : I/O 매니져가 호출자의 버퍼 크기와 동일한 버퍼를 넌페이지드 풀에 할당하고   
Write의 경우에는 버퍼 데이터를 IRP 생성 시 할당한 넌페이지드 버퍼에 복사를 합니다.  
반대로 Read의 경우에는 IRP가 완료 될 때 할당된 넌페이지드 버퍼로부터 유저 버퍼로 복사한 뒤 할당 된 넌페이지드 버퍼를 해제합니다.  
넌페이지드 풀에 할당 된 버퍼는 IRP의 AssociatedIrp.SystemBuffer 필드가 가르키게 됩니다.  
일반적으로 1페이지(4K) 이하의 요청을 전달 할 때나 DMA를 지원하지 않을 때 버퍼드 I/O를 사용합니다.  
 

## 다이렉트 I/O (Direct I/O) : I/O 매니져가 IRP를 생성 할 때 메모리에 유저 버퍼를 락 시킵니다. (즉 넌페이지드가 됨)  
그리고 I/O 관리자는 MDL(Memory Descriptor List)의 형태로 메모리의 디스크립션(description)을 저장하고   
MDL은 버퍼가 차지하고 있는 물리 메모리를 명시하게 되며 IRP의 MdlAddress 필드가 가르키게 됩니다.  
다이렉트 I/O의 경우는 DMA(Direct Memory Access)를 수행하는 장치가 버퍼의 물리적 디스크립션만 필요로하기 때문에   
이런 장치의 동작에 적합하여 대용량 데이터 요청일 때 다이렉트 I/O를 사용합니다.  
그러나 드라이버가 버퍼의 내용에 접근해야 한다면 버퍼를 시스템의 주소 공간에 매핑할 수 있습니다.  
그리고 IRP 사용을 완료하면 버퍼를 언락 시키게 됩니다.  
 

## Neither I/O : I/O 매니져는 어떤 버퍼 관리도 수행하지 않습니다. 대신 디바이스 드라이버가 버퍼를 관리 합니다.  
디바이스 드라이버는 I/O 관리자가 수행하는 단계를 그 밖의 다른 버퍼 관리 유형으로 수동 수행하게 선택할 수 있으며  
IRP의 UserBuffer 필드가 가르키게 됩니다.  
보통 파일 시스템 드라이버는 Neither I/O를 사용합니다. 파일 시스템 캐시에서 호출자의 원래 버퍼로 데이터를 복사할 때  
버퍼 관리에 대한 부하가 없기 때문입니다. 하지만 대부분의 드라이버가 Neither I/O를 사용하지 않는데 그 이유는  
호출자의 버퍼가 요청한 프로세스의 스레드가 실행 중인 동안에만 유효하기 때문입니다.  
따라서 Neither I/O를 사용해 유저 공간에 위치하는 버퍼에 접근하는 드라이버는 버퍼 주소가 유효하고   
커널 모드 메모리를 참조하지 않음을 보장 받기 위해 각별히 주의 해야 합니다.  
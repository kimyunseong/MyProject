# 지연 쓰기(lazy write)  

캐시에 있는 데이터를 얼마나 자주 플러시 할 것인가를 결정하는 것은 매우 중요합니다.  
캐시에 있는 데이터를 자주 플러시 하게 된다면 디스크 I/O 작업이 가장 오래 걸리는 작업에 속하게 됨으로써 시스템 성능에 저하를   
가져올 수 있으며, 변경된 페이지들에 의한 메모리 잠식으로 물리 메모리를 소진시킬 위험성이 있습니다.  
그래서 착안한 방법이 캐시와 디스크의 데이터가 일치하지 않지만 캐시에 먼저 기록을 하고 이 후 지연 쓰기 작업에 의해서  
디스크에 기록하는 방식을 재기록(write-back) 캐시 라고 합니다.  

## 재기록(write-back)  
메모리에 대한 쓰기 작업 요청 시 캐시에서만 쓰기 작업과 그 변경 사실을 확인할 수 있는 표시를 해 놓고 캐시로부터   
해당 블록이 제거될 때 그 블록을 메인 메모리에 복사함으로써 메인 메모리와 캐시의 내용을 동일하게 유지하는 방식입니다.   
이 방식은 동일한 블록 내에서 여러번 쓰기를 실행하는 경우 캐시에만 여러 번 쓰기를 하고   
메인 메모리에 한번만 쓰게 되므로 매우 효울적인 방식입니다.  

## 캐시 매니져는 메모리 매니져의 맵 기록자 스레드를 정지할 수 있습니다.  
변경 리스트는 논리 블록 주소(LAB, Logical Block Address) 순서로 정렬 돼 있지 않기 때문에 캐시 매니져가   
디스크에 대한 크고 연속적인 I/O의 페이지를 모으는 시도는 항상 성공이지 않거나 반복적으로 검색하게 만듭니다.  
이런 영향을 극복하기 위해 캐시 매니져는 적극적으로 맵 기록자 스레드를 멈추게 하고   
가상 바이트 오프셋 (VBO, Vrtual Byte Offset) 순서로 쓰게 만들 수 있고,  
캐시 매니져가 이런 쓰기 행위를 소유함으로써 미리 읽기와 이면 쓰기를 더욱 사용하고 시스템에 영향을   
덜 줄 수 있는 자신의 스케줄링과 조절 알고리즘 적용이 가능해졌습니다.  

따라서 지연 쓰기(lazy-write)는 캐시 관리자의 지연 기록자가 시스템 작업자 스레드에서 초당 1회 실행 돼   
시스템 캐시 내 더티 페이지의 1/8을 디스크에 쓰게 합니다.  
더티 페이지의 생성률이 지연 쓰기가 결정하는 써야 할 양보다 큰 경우, 지연 쓰기는 더티 페이지의 생성률에   
맞춰 필요한 만큼의 더티 페이지를 추가로 디스크에 쓰기도 합니다.  
실제 I/O 작업을 수행하는 것은 시스템 전역적인 크리티컬 작업자 스레드 풀의 시스템 작업자 스레드이고,   
지연 쓰기는 또한 메모리 매니져의 맵 페이지 기록자가 언제 플러시를 수행했는지 알고 있고,  
이런 경우 지연 쓰기는 재기록 기능을 연기해 동일한 파일에 두번의 플러시가 수행되지 않게 해줍니다.  

참고 문헌 : Windows Internals
